<?php
//prevents caching
header("Expires: Sat, 01 Jan 2000 00:00:00 GMT");
header("Last-Modified: ".gmdate("D, d M Y H:i:s")." GMT");
header("Cache-Control: post-check=0, pre-check=0",false);
session_cache_limiter();

session_start();

//require the config file
require ("../config.php");
require ("../functions.php");

if ($page == ""){$page = 1;}
	
//check for authority to view this page
if (allow_access(Administrators) != "yes")
  {
    echo "You are not authorized to perform this function";
    exit;
  }
?>

<head>
<meta http-equiv="Content-Language" content="en-us">

<style type="text/css" media="screen">
@import url("../../css/rapd.css");
</style>
</head>
<body topmargin="0" leftmargin="10" rightmargin="0" bottommargin="0">
  <h1>RAPD Trip Administration</h1>

<?php
//make the connection to the database
$connection = @mysql_connect($server, $dbusername, $dbpassword) or die(mysql_error());
$db = @mysql_select_db($db_name,$connection)or die(mysql_error());

//make query to database
$sql ="SELECT * FROM trips WHERE user_name='$_SESSION[username1]' AND data_root_dir='$_POST[data]' AND beamline='$_POST[beamline]'";
$result = @mysql_query($sql,$connection) or die(mysql_error());

//get the number of rows in the result set
$num = mysql_num_rows($result);
//echo "<P>$num</P>";

//check if that username already exists
if ($num == 0)
  {
      echo "<P>Sorry, there is no match in the database for the trip you have requested to delete.</P>";
      echo "<P><a href=\"trips.php\">Back to trips</a></p>";
      echo "<P><a href=\"adminpage.php\">Back to the administrative control panel</a></p>";  
      mysql_close($connection);
  }
elseif ($num > 1)
  {
      echo "<P>Sorry, there is more than one entry in the trips database that matches.</P>";
      echo "<P>Please edit the database manually.</P>";
      echo "<P><a href=\"trips.php\">Back to trips.</a></p>";
      echo "<P><a href=\"adminpage.php\">Back to the administrative control panel</a></p>";
      mysql_close($connection);
  }
else
  {
    //put results which correspond to this trip into the orphan_results table and directory
    $db      = @mysql_select_db('rapd_data',$connection)or die(mysql_error());    

    //snaps
    $sql1    = "SELECT * FROM single_results WHERE data_root_dir='$_POST[data]'";
    $result1 = @mysql_query($sql1,$connection) or die(mysql_error());
    while ($sql1 = mysql_fetch_object($result1))
      {
        //put in the database
        $id   = $sql1 -> single_result_id;
        $date = $sql1 -> date;
        $sql2    = "INSERT INTO orphan_results (type,data_root_dir,result_id,date) VALUES ('single','$_POST[data]','$id','$date')";
        $result2 = @mysql_query($sql2,$connection) or die(mysql_error());
        
        //move the files
        
      }

    //pairs
    $sql1    = "SELECT * FROM pair_results WHERE data_root_dir='$_POST[data]'";
    $result1 = @mysql_query($sql1,$connection) or die(mysql_error());
    while ($sql1 = mysql_fetch_object($result1))
      {
        //put in the database
        $id   = $sql1 -> pair_result_id;
        $date = $sql1 -> date;
        $sql2    = "INSERT INTO orphan_results (type,data_root_dir,result_id,date) VALUES ('pair','$_POST[data]','$id','$date')";
        $result2 = @mysql_query($sql2,$connection) or die(mysql_error());
      
        //move the files

      }

    //runs
    $sql1    = "SELECT * FROM run_results WHERE data_root_dir='$_POST[data]'";
    $result1 = @mysql_query($sql1,$connection) or die(mysql_error());
    while ($sql1 = mysql_fetch_object($result1))
      {
        //put in the database
        $id   = $sql1 -> run_result_id;
        $date = $sql1 -> date;
        $sql2    = "INSERT INTO orphan_results (type,data_root_dir,result_id,date) VALUES ('run','$_POST[data]','$id','$date')";
        $result2 = @mysql_query($sql2,$connection) or die(mysql_error());
      
        //move the files

      }

    //now remove the trip from the trips table
    $db =  @mysql_select_db($db_name,$connection)or die(mysql_error());
    $sql_del = "DELETE FROM trips WHERE user_name='$_SESSION[username1]' AND data_root_dir='$_POST[data]' AND beamline='$_POST[beamline]'";
    $result = @mysql_query($sql_del,$connection) or die(mysql_error());
    echo "<P>Trip successfully deleted from the database.</P>";
    echo "<P><a href=\"trips.php\">Back to trips</a></p>";
    echo "<P><a href=\"adminpage.php\">Back to the administrative control panel</a></p>";
    mysql_close($connection);
  }
?>
